---
import Layout from '../../layouts/Layout.astro';
import '../../styles/grid.css';
import GalleryCard from '../../components/GalleryCard.astro';
import { getAusstellung, urlFor } from '../../lib/sanity';

const { id } = Astro.params;
const ausstellung = await getAusstellung(id);

if (!ausstellung) {
  return Astro.redirect('/404');
}

// Map exponate to gallery items
let exponateItems = [];
try {
  exponateItems = (ausstellung.exponate || []).map((ex) => ({
    id: ex._id,
    title: ex.titel,
    subtitle: ex.untertitel || '',
    image: ex.hauptbild ? urlFor(ex.hauptbild).width(1600).height(undefined).auto('format').url() : '/placeholder.jpg',
    imageHd: ex.hauptbild ? urlFor(ex.hauptbild).width(3000).height(undefined).auto('format').url() : '/placeholder.jpg',
    ratio: '1 / 1',
    inventarnummer: ex.inventarnummer,
    kurzbeschreibung: ex.kurzbeschreibung,
    kategorie: ex.kategorie,
    ist_highlight: ex.ist_highlight,
  }));
} catch {}

// Map highlight exponate
let highlightItems = [];
try {
  highlightItems = (ausstellung.highlight_exponate || []).map((ex) => ({
    id: ex._id,
    title: ex.titel,
    subtitle: ex.untertitel || '',
    image: ex.hauptbild ? urlFor(ex.hauptbild).width(1600).height(undefined).auto('format').url() : '/placeholder.jpg',
    imageHd: ex.hauptbild ? urlFor(ex.hauptbild).width(3000).height(undefined).auto('format').url() : '/placeholder.jpg',
    ratio: '1 / 1',
    inventarnummer: ex.inventarnummer,
    kurzbeschreibung: ex.kurzbeschreibung,
    beschreibung: ex.beschreibung,
    datierung: ex.datierung,
    herstellung: ex.herstellung,
    physisch: ex.physisch,
    kategorie: ex.kategorie,
  }));
} catch {}
---

<Layout title={ausstellung.titel} theme="light">
  <main class="blank">
    <section class="container">
      <!-- Hero Image -->
      {ausstellung.titelbild && (
        <div class="hero-section">
          <img
            src={urlFor(ausstellung.titelbild).width(2400).height(800).fit('crop').auto('format').url()}
            alt={ausstellung.titelbild.alt || ausstellung.titel}
            class="hero-image"
          />
          <div class="hero-overlay">
            <h1 class="hero-title">{ausstellung.titel}</h1>
            {ausstellung.untertitel && (
              <p class="hero-subtitle">{ausstellung.untertitel}</p>
            )}
          </div>
        </div>
      )}

      <!-- Info Bar -->
      <div class="info-bar">
        {ausstellung.zeitraum?.zeitraum_text && (
          <div class="info-item">
            <span class="info-icon">üìÖ</span>
            <span class="info-text">{ausstellung.zeitraum.zeitraum_text}</span>
          </div>
        )}
        {ausstellung.organisation?.ort && (
          <div class="info-item">
            <span class="info-icon">üìç</span>
            <span class="info-text">{ausstellung.organisation.ort}</span>
          </div>
        )}
        {ausstellung.organisation?.kurator && (
          <div class="info-item">
            <span class="info-icon">üë§</span>
            <span class="info-text">{ausstellung.organisation.kurator}</span>
          </div>
        )}
      </div>

      <!-- Description -->
      {ausstellung.kurzbeschreibung && (
        <div class="lead-text">
          <p>{ausstellung.kurzbeschreibung}</p>
        </div>
      )}

      <!-- Highlight Exponate -->
      {highlightItems.length > 0 && (
        <div class="section">
          <h2 class="section-title">Highlights</h2>
          <div class="gallery-grid">
            {highlightItems.map((it) => (
              <div class="gitem" data-id={it.id} data-title={it.title} data-subtitle={it.subtitle || ''} data-image={it.image} data-image-hd={it.imageHd} data-inventarnummer={it.inventarnummer} data-kurzbeschreibung={it.kurzbeschreibung} data-beschreibung={it.beschreibung} data-datierung={JSON.stringify(it.datierung)} data-herstellung={JSON.stringify(it.herstellung)} data-physisch={JSON.stringify(it.physisch)}>
                <GalleryCard title={it.title} subtitle={it.subtitle} image={it.image} ratio={it.ratio} />
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- All Exponate -->
      {exponateItems.length > 0 && (
        <div class="section">
          <h2 class="section-title">Alle Exponate ({exponateItems.length})</h2>
          <div class="gallery-grid">
            {exponateItems.map((it) => (
              <div class="gitem-compact">
                <a href={`/exponat/${it.id}`} class="compact-card touchable">
                  {it.image && (
                    <div class="compact-image">
                      <img src={it.image} alt={it.title} loading="lazy" />
                    </div>
                  )}
                  <div class="compact-info">
                    <div class="compact-title">{it.title}</div>
                    {it.inventarnummer && (
                      <div class="compact-inv">{it.inventarnummer}</div>
                    )}
                  </div>
                </a>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Veranstaltungen -->
      {ausstellung.veranstaltungen && ausstellung.veranstaltungen.length > 0 && (
        <div class="section">
          <h2 class="section-title">Veranstaltungen</h2>
          <div class="events-list">
            {ausstellung.veranstaltungen.map((event) => (
              <div class="event-card">
                <div class="event-icon">
                  {event.typ === 'eroeffnung' ? 'üéâ' :
                   event.typ === 'fuehrung' ? 'üë•' :
                   event.typ === 'vortrag' ? 'üé§' :
                   event.typ === 'workshop' ? 'üî®' :
                   event.typ === 'finissage' ? 'ü•Ç' : 'üìÖ'}
                </div>
                <div class="event-content">
                  <div class="event-title">{event.titel}</div>
                  {event.datum && (
                    <div class="event-date">
                      {new Date(event.datum).toLocaleDateString('de-DE', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                      })}
                    </div>
                  )}
                  {event.beschreibung && (
                    <div class="event-desc">{event.beschreibung}</div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Back Button -->
      <div class="back-nav">
        <a href="/ausstellungen" class="back-btn touchable">‚Üê Zur√ºck</a>
      </div>
    </section>
  </main>

  <!-- Modal for Highlight Exponate -->
  <div id="modal" class="modal-overlay" hidden>
    <div class="modal-backdrop"></div>
    <div class="modal-content-wrapper">
      <div class="modal-content">
        <div class="modal-image-container">
          <img id="modal-image" src="" alt="" />
          <div id="magnifying-glass" class="magnifying-glass" hidden></div>
        </div>
        <div class="modal-buttons">
          <button id="fullscreen-btn" class="fullscreen-btn" aria-label="Vollbild">
            <i data-lucide="maximize"></i>
          </button>
          <button id="magnifier-btn" class="magnifier-btn" aria-label="Lupe">
            <i data-lucide="search"></i>
          </button>
        </div>
        <div class="modal-info-container">
          <h2 id="modal-title"></h2>
          <p id="modal-subtitle"></p>
          <div id="modal-metadata"></div>
        </div>
      </div>
    </div>
    <button class="modal-close" aria-label="Schlie√üen">
      <i data-lucide="x"></i>
    </button>
    <button id="fullscreen-close-btn" class="fullscreen-close-btn" aria-label="Vollbild schlie√üen" hidden>
      <i data-lucide="x"></i>
    </button>
  </div>

  <style>
    .blank {
      min-height: 100vh;
      width: 100vw;
      background: var(--bg);
      padding: 0 0 var(--space-8);
      overflow-x: hidden;
    }

    .hero-section {
      position: relative;
      width: 100vw;
      height: 60vh;
      min-height: 400px;
      max-height: 700px;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      overflow: hidden;
      margin-bottom: var(--space-6);
    }

    .hero-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.1) 100%);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-end;
      padding: var(--space-6);
    }

    .hero-title {
      font-size: clamp(32px, 6vw, 72px) !important;
      font-weight: 900 !important;
      color: white;
      margin: 0;
      text-shadow: 0 2px 20px rgba(0,0,0,0.5);
      max-width: 1200px;
    }

    .hero-subtitle {
      font-size: clamp(18px, 3vw, 32px) !important;
      font-weight: 500 !important;
      color: rgba(255,255,255,0.9);
      margin: var(--space-2) 0 0;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    .info-bar {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--bg-alt);
      margin-bottom: var(--space-6);
    }

    :root[data-theme="dark"] .info-bar {
      background: #111;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-icon {
      font-size: 20px !important;
    }

    .info-text {
      font-size: 16px !important;
      color: var(--text);
    }

    .lead-text {
      font-size: 22px !important;
      line-height: 1.7;
      font-weight: 500 !important;
      margin-bottom: var(--space-6);
      color: var(--text);
    }

    .section {
      margin-top: var(--space-8);
    }

    .section-title {
      font-size: 36px !important;
      font-weight: 900 !important;
      margin-bottom: var(--space-4);
      color: var(--text);
    }

    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 40px;
    }

    @media (min-width: 900px) {
      .gallery-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }

    @media (min-width: 1280px) {
      .gallery-grid {
        grid-template-columns: repeat(5, minmax(0,1fr));
      }
    }

    .gitem {
      cursor: pointer;
    }

    .gitem-compact {
      /* Compact list for all exponate */
    }

    .compact-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      background: var(--bg-alt);
      text-decoration: none;
      color: inherit;
    }

    :root[data-theme="dark"] .compact-card {
      background: #111;
    }

    .compact-card:hover {
      background: var(--border);
    }

    .compact-image {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .compact-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .compact-title {
      font-size: 16px !important;
      font-weight: 700 !important;
      color: var(--text);
    }

    .compact-inv {
      font-size: 14px !important;
      color: var(--text-dim);
      opacity: 0.8;
    }

    .events-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .event-card {
      display: flex;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--bg-alt);
    }

    :root[data-theme="dark"] .event-card {
      background: #111;
    }

    .event-icon {
      font-size: 32px !important;
      flex-shrink: 0;
    }

    .event-title {
      font-size: 20px !important;
      font-weight: 700 !important;
      margin-bottom: 4px;
      color: var(--text);
    }

    .event-date {
      font-size: 16px !important;
      font-weight: 600 !important;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .event-desc {
      font-size: 16px !important;
      color: var(--text-dim);
      line-height: 1.5;
    }

    .back-nav {
      margin-top: var(--space-8);
      padding-top: var(--space-6);
      border-top: 1px solid var(--border);
    }

    .back-btn {
      display: inline-block;
      font-size: 18px !important;
      font-weight: 700 !important;
      color: var(--text);
      text-decoration: none;
      padding: 12px 20px;
      background: var(--bg-alt);
    }

    :root[data-theme="dark"] .back-btn {
      background: #111;
    }

    .back-btn:hover {
      background: var(--border);
    }

    /* Modal Styles (from index.astro) */
    .modal-overlay { position: fixed; inset: 0; z-index: 100; display: grid; place-items: center; padding: 1rem; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); }
    :root:not([data-theme="dark"]) .modal-backdrop { background: rgba(255, 255, 255, 0.8); }
    .modal-content-wrapper { position: relative; z-index: 1; width: 100%; max-width: 1200px; max-height: 90vh; overflow: visible; }
    .modal-content { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr auto; gap: 3rem; color: white; border-radius: 0; overflow: visible; background: transparent; border: none; }
    :root:not([data-theme="dark"]) .modal-content { background: #fff; color: #000; }
    .modal-image-container { grid-column: 1; grid-row: 1; position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
    .modal-image-container img { max-width: 75vh; max-height: 75vh; object-fit: contain; display: block; }
    .modal-buttons { grid-column: 1; grid-row: 2; display: flex; justify-content: center; gap: 1rem; padding: 1rem; background: transparent; border: none; margin: 0; }
    .fullscreen-btn, .magnifier-btn { background: transparent; border: none; color: white; cursor: pointer; z-index: 2; padding: 0; width: 40px; height: 40px; display: grid; place-items: center; }
    .fullscreen-btn svg, .magnifier-btn svg { stroke: white; width: 24px; height: 24px; }
    :root:not([data-theme="dark"]) .fullscreen-btn svg, :root:not([data-theme="dark"]) .magnifier-btn svg { stroke: #000; }
    .magnifier-btn.active { background: rgba(255,255,255,0.2); }
    .modal-info-container { grid-column: 2; grid-row: 1 / 3; padding: 2rem; overflow-y: auto; }
    #modal-title { font-size: 32px !important; font-weight: 900; }
    #modal-subtitle { font-size: 18px !important; opacity: 0.8; margin-bottom: 1.5rem; }
    #modal-metadata { display: grid; gap: 1rem; }
    .meta-item { display: grid; grid-template-columns: 100px 1fr; gap: 1rem; }
    .meta-item strong { font-weight: 600; }
    .modal-close { position: absolute; top: 1rem; right: 1rem; z-index: 2; background: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; font-size: 1.5rem; cursor: pointer; }
    :root:not([data-theme="dark"]) .modal-close { background: transparent !important; color: #000 !important; }
    .fullscreen-close-btn { position: fixed !important; top: 2rem !important; right: 2rem !important; background: rgba(0,0,0,0.8) !important; color: white !important; border: none !important; border-radius: 50% !important; width: 4rem !important; height: 4rem !important; font-size: 128px !important; font-weight: 900 !important; cursor: pointer !important; z-index: 102 !important; display: flex !important; align-items: center !important; justify-content: center !important; }
    .magnifying-glass { position: fixed; border: 4px solid #fff; border-radius: 50%; cursor: grab; width: 250px; height: 250px; transform: translate(-50%, -50%); pointer-events: auto; overflow: hidden; background-repeat: no-repeat; background-size: cover; z-index: 103; display: none; transition: opacity 0.2s ease; user-select: none; background-color: rgba(255, 255, 255, 0.1); }
    .magnifying-glass:active { cursor: grabbing; }
    .modal-overlay.modal-fullscreen .modal-info-container { display: none; }
    .modal-overlay.modal-fullscreen .modal-close { display: none; }
    .modal-overlay.modal-fullscreen .modal-image-container { position: fixed !important; inset: 0 !important; z-index: 101 !important; width: 100vw !important; height: 100vh !important; }
    .modal-overlay.modal-fullscreen #modal-image { width: 100% !important; height: 100% !important; object-fit: contain !important; }

    @media (max-width: 768px) {
      .modal-content { grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
      .modal-image-container { grid-column: 1; grid-row: 1; }
      .modal-buttons { grid-column: 1; grid-row: 2; }
      .modal-info-container { grid-column: 1; grid-row: 3; padding: 1.5rem; }
      .gallery-grid { grid-template-columns: repeat(2, minmax(0,1fr)) !important; gap: 20px; }
    }
  </style>

  <script>
    import { animate } from "motion";
    import Hammer from 'hammerjs';

    // Initialize Lucide icons
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    });

    const modal = document.getElementById('modal');
    const modalImage = document.getElementById('modal-image');
    const modalTitle = document.getElementById('modal-title');
    const modalSubtitle = document.getElementById('modal-subtitle');
    const modalMetadata = document.getElementById('modal-metadata');
    const modalClose = document.querySelector('.modal-close');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const magnifyingGlass = document.getElementById('magnifying-glass');
    const magnifierBtn = document.getElementById('magnifier-btn');
    const MAGNIFICATION_FACTOR = 4;

    let activeItem = null;
    let hammer;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    let magnifierActive = false;

    function openModal(item) {
      try {
        activeItem = item;
        const image = item.querySelector('img');
        const title = item.dataset.title;
        const subtitle = item.dataset.subtitle;
        const hdImage = item.dataset.imageHd;
        const inventarnummer = item.dataset.inventarnummer;
        const kurzbeschreibung = item.dataset.kurzbeschreibung;
        const beschreibung = item.dataset.beschreibung;
        const datierung = JSON.parse(item.dataset.datierung || '{}');
        const herstellung = JSON.parse(item.dataset.herstellung || '{}');
        const physisch = JSON.parse(item.dataset.physisch || '{}');

        modalImage.src = image.src;
        modalTitle.textContent = title;
        modalSubtitle.textContent = subtitle;

        let metadataHtml = '';
        if (inventarnummer) metadataHtml += `<div class="meta-item"><strong>Inventarnr.:</strong> <span>${inventarnummer}</span></div>`;
        if (datierung?.jahr_text) metadataHtml += `<div class="meta-item"><strong>Datierung:</strong> <span>${datierung.jahr_text}</span></div>`;
        if (herstellung?.material) metadataHtml += `<div class="meta-item"><strong>Material:</strong> <span>${herstellung.material}</span></div>`;
        if (physisch?.masse) metadataHtml += `<div class="meta-item"><strong>Ma√üe:</strong> <span>${physisch.masse}</span></div>`;
        if (kurzbeschreibung) metadataHtml += `<div class="meta-item"><strong>Info:</strong> <span>${kurzbeschreibung}</span></div>`;

        modalMetadata.innerHTML = metadataHtml;

        const transitionName = `gallery-item-${item.dataset.id}`;
        modalImage.style.viewTransitionName = transitionName;
        image.style.viewTransitionName = transitionName;

        modal.hidden = false;
        document.documentElement.style.overflow = 'hidden';
        document.getElementById('fullscreen-close-btn').hidden = false;

        if (!document.startViewTransition) {
          animate(modal, { opacity: [0, 1] }, { duration: 0.3 });
        } else {
          const transition = document.startViewTransition(() => {});
          transition.ready.then(() => {
            animate(modal.querySelector(".modal-backdrop"), { opacity: [0, 1] }, { duration: 0.5, easing: "ease-in-out" });
            animate(modal.querySelector(".modal-content"), { transform: ["scale(0.95)", "scale(1)"], opacity: [0, 1] }, { duration: 0.5, easing: "ease-in-out" });
          });
        }

        const hdLoader = new Image();
        hdLoader.src = hdImage;
        hdLoader.onload = () => {
          modalImage.src = hdImage;
          const img = new Image();
          img.src = hdImage;
          img.onload = () => {
            const ratio = img.width / img.height;
            if (ratio > 1) {
              modalImage.style.width = '75vh';
              modalImage.style.height = 'auto';
            } else {
              modalImage.style.height = '75vh';
              modalImage.style.width = 'auto';
            }
          }
        };

        const mc = new Hammer.Manager(modal);
        mc.add(new Hammer.Pinch());
        mc.add(new Hammer.Swipe({ direction: Hammer.DIRECTION_DOWN }));

        let scale = 1;
        mc.on('pinch', (ev) => {
          scale = Math.max(0.5, Math.min(scale * ev.scale, 3));
          modalImage.style.transform = `scale(${scale})`;
        });

        mc.on('swipedown', closeModal);
        hammer = mc;
      } catch (e) {
        console.error('Error in openModal:', e);
      }
    }

    function closeModal() {
      try {
        if (modal.classList.contains('modal-fullscreen')) {
          toggleFakeFullscreen();
          return;
        }
        if (!activeItem) return;
        if (hammer) { hammer.destroy(); hammer = null; }

        const image = activeItem.querySelector('img');
        const transitionName = `gallery-item-${activeItem.dataset.id}`;

        const cleanup = () => {
          modal.hidden = true;
          document.documentElement.style.overflow = '';
          if (modalImage) {
            modalImage.style.viewTransitionName = '';
            modalImage.style.transform = 'scale(1)';
          }
          if (image) image.style.viewTransitionName = '';
          if (magnifierActive) {
            hideMagnifyingGlass();
            magnifierActive = false;
            magnifierBtn.classList.remove('active');
          }
          activeItem = null;
        }

        if (!document.startViewTransition) {
          animate(modal, { opacity: [1, 0] }, { duration: 0.3 }).finished.then(cleanup);
          return;
        }

        if (modalImage) modalImage.style.viewTransitionName = transitionName;
        if (image) image.style.viewTransitionName = transitionName;

        const transition = document.startViewTransition(() => {});
        transition.finished.finally(cleanup);
      } catch (e) {
        console.error('Error in closeModal:', e);
      }
    }

    function showMagnifyingGlass() {
      magnifyingGlass.hidden = false;
      magnifyingGlass.style.display = 'block';
      const imageRect = modalImage.getBoundingClientRect();
      const centerX = imageRect.left + imageRect.width / 2;
      const centerY = imageRect.top + imageRect.height / 2;
      magnifyingGlass.style.left = centerX + 'px';
      magnifyingGlass.style.top = centerY + 'px';
      magnifyingGlass.style.position = 'fixed';
      updateMagnifyingGlassContent();
    }

    function hideMagnifyingGlass() {
      magnifyingGlass.hidden = true;
    }

    function toggleMagnifier() {
      magnifierActive = !magnifierActive;
      if (magnifierActive) {
        showMagnifyingGlass();
        magnifierBtn.classList.add('active');
      } else {
        hideMagnifyingGlass();
        magnifierBtn.classList.remove('active');
      }
    }

    function updateMagnifyingGlassContent() {
      if (!modalImage.src || magnifyingGlass.hidden) return;
      const imageRect = modalImage.getBoundingClientRect();
      const glassRect = magnifyingGlass.getBoundingClientRect();
      const glassCenterX = glassRect.left + glassRect.width / 2;
      const glassCenterY = glassRect.top + glassRect.height / 2;
      const offsetX = glassCenterX - imageRect.left;
      const offsetY = glassCenterY - imageRect.top;
      magnifyingGlass.style.backgroundImage = `url('${modalImage.src}')`;
      const bgX = offsetX * MAGNIFICATION_FACTOR - (glassRect.width / 2);
      const bgY = offsetY * MAGNIFICATION_FACTOR - (glassRect.height / 2);
      magnifyingGlass.style.backgroundSize = `${imageRect.width * MAGNIFICATION_FACTOR}px ${imageRect.height * MAGNIFICATION_FACTOR}px`;
      magnifyingGlass.style.backgroundPosition = `${-bgX}px ${-bgY}px`;
    }

    function toggleFakeFullscreen() {
      const isCurrentlyFullscreen = modal.classList.contains('modal-fullscreen');
      if (isCurrentlyFullscreen) {
        modal.classList.remove('modal-fullscreen');
        const closeBtn = document.getElementById('fullscreen-close-btn');
        closeBtn.hidden = true;
        closeBtn.innerHTML = '<i data-lucide="x"></i>';
        lucide.createIcons();
        magnifyingGlass.hidden = true;
      } else {
        modal.classList.add('modal-fullscreen');
        const closeBtn = document.getElementById('fullscreen-close-btn');
        closeBtn.hidden = false;
        closeBtn.innerHTML = '<i data-lucide="arrow-left"></i>';
        lucide.createIcons();
        closeBtn.style.setProperty('font-size', '128px', 'important');
        closeBtn.style.setProperty('font-weight', '900', 'important');
      }
    }

    const fullscreenCloseBtn = document.getElementById('fullscreen-close-btn');
    fullscreenCloseBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      closeModal();
    });

    fullscreenBtn.addEventListener('click', () => {
      toggleFakeFullscreen();
    });

    magnifierBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMagnifier();
    });

    magnifyingGlass.addEventListener('mousedown', (e) => {
      if (!magnifierActive) return;
      e.preventDefault();
      isDragging = true;
      const rect = magnifyingGlass.getBoundingClientRect();
      dragOffset.x = e.clientX - (rect.left + rect.width / 2);
      dragOffset.y = e.clientY - (rect.top + rect.height / 2);
      magnifyingGlass.style.cursor = 'grabbing';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging || !magnifierActive) return;
      e.preventDefault();
      const x = e.clientX - dragOffset.x;
      const y = e.clientY - dragOffset.y;
      magnifyingGlass.style.left = x + 'px';
      magnifyingGlass.style.top = y + 'px';
      updateMagnifyingGlassContent();
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        magnifyingGlass.style.cursor = 'grab';
      }
    });

    magnifyingGlass.addEventListener('touchstart', (e) => {
      if (!magnifierActive) return;
      e.preventDefault();
      isDragging = true;
      const rect = magnifyingGlass.getBoundingClientRect();
      dragOffset.x = e.touches[0].clientX - (rect.left + rect.width / 2);
      dragOffset.y = e.touches[0].clientY - (rect.top + rect.height / 2);
    });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging || !magnifierActive) return;
      e.preventDefault();
      const x = e.touches[0].clientX - dragOffset.x;
      const y = e.touches[0].clientY - dragOffset.y;
      magnifyingGlass.style.left = x + 'px';
      magnifyingGlass.style.top = y + 'px';
      updateMagnifyingGlassContent();
    });

    document.addEventListener('touchend', () => {
      if (isDragging) {
        isDragging = false;
      }
    });

    const galleryItems = document.querySelectorAll('.gitem');
    galleryItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        openModal(item);
      });
    });

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-backdrop')) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.hidden) {
        closeModal();
      }
    });
  </script>
</Layout>
