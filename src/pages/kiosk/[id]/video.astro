---
import { getKioskConfig } from '../../../lib/sanity';

const { id } = Astro.params;

let config = null;
let error = null;
let videos = [];
let audioVolume = 70;
let audioMuted = false;
let showSubtitles = false;
let loopPlaylist = true;

try {
  config = await getKioskConfig(id);
  if (!config) {
    error = `Kiosk "${id}" nicht gefunden`;
  } else {
    // Get audio settings
    const audioSettings = config?.konfiguration?.video_settings?.audio || {};
    audioVolume = audioSettings.lautstaerke || 70;
    audioMuted = audioSettings.stumm === true;

    // Get subtitle setting
    showSubtitles = config?.konfiguration?.video_settings?.zeige_untertitel === true;

    // Get loop setting
    loopPlaylist = config?.konfiguration?.video_settings?.loop !== false;

    // Convert Sanity playlist to video format
    const playlist = config?.konfiguration?.video_settings?.playlist || [];
    videos = playlist.map((item) => {
      let url = null;
      if (item.typ === 'video') {
        url = item.video_url || item.video?.asset?.url;
      } else if (item.typ === 'image') {
        url = item.bild?.asset?.url;
      }
      return {
        url,
        title: item.titel || '',
        description: item.beschreibung || '',
        typ: item.typ,
        dauer: item.dauer || 10,
        subtitles: item.untertitel?.asset?.url || null
      };
    }).filter(v => v.url);
  }
} catch (e) {
  error = `Fehler: ${e.message}`;
}
---

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" content="notranslate">
  <title>{config?.name || 'Video Player'}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      overflow: hidden;
    }

    .error-screen {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
    }

    .error-screen h1 {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .container {
      width: 100vw;
      height: 100vh;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video, img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }

    video.active, img.active {
      opacity: 1;
      z-index: 1;
    }

    .overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 10;
      background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.85) 80%, transparent 100%);
      padding: 80px 60px 40px;
    }

    .overlay-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 60px;
    }

    .overlay-left {
      flex: 0 1 auto;
    }

    .overlay h2 {
      font-size: 40px;
      margin: 0 0 5px;
      font-weight: 600;
    }

    .overlay .function {
      font-size: 24px;
      margin: 0;
      opacity: 0.85;
      font-weight: 400;
    }

    .subtitles {
      font-size: 28px;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      min-height: 45px;
      text-align: left;
      opacity: 0.95;
      flex: 1 1 auto;
    }

    .progress {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
      background: rgba(0,0,0,0.7);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 20px;
    }

    .start-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.95);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      cursor: pointer;
    }

    .start-screen.hidden {
      display: none;
    }

    .play-button {
      font-size: 120px;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }

    .start-text {
      font-size: 24px;
      opacity: 0.8;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .status {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
      background: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      font-family: monospace;
    }

    /* Hide native video subtitles - we show them in overlay */
    video::cue {
      opacity: 0;
      display: none;
    }

    video::-webkit-media-text-track-container {
      display: none;
    }
  </style>
</head>
<body>
  {error || videos.length === 0 ? (
    <div class="error-screen">
      <div>
        <h1>⚠️</h1>
        <p>{error || 'Keine Videos in der Playlist'}</p>
      </div>
    </div>
  ) : (
    <>
      <div class="start-screen" id="startScreen">
        <div class="play-button">▶</div>
        <div class="start-text">Klicken zum Starten</div>
      </div>

      <div class="container" id="container">
        <video id="media1" playsinline webkit-playsinline preload="auto"></video>
        <video id="media2" playsinline webkit-playsinline preload="auto"></video>
        <img id="img1" style="display:none;" />
        <img id="img2" style="display:none;" />
      </div>

      <div class="overlay" id="overlay">
        <div class="overlay-content">
          <div class="overlay-left">
            <h2 id="title">Video Title</h2>
            <div id="function" class="function"></div>
          </div>
          <div id="subtitles" class="subtitles" style="display:none;"></div>
        </div>
      </div>

      <div class="progress" id="progress">
        <span id="current">1</span> / <span id="total">{videos.length}</span>
      </div>

      <div class="status" id="status">Loading...</div>

      <script define:vars={{ videos, audioVolume, audioMuted, showSubtitles, loopPlaylist }}>
        console.log('Videos data:', videos);
        console.log('Show subtitles:', showSubtitles);
        console.log('Loop playlist:', loopPlaylist);
        videos.forEach((v, i) => {
          console.log(`Video ${i+1}: ${v.title}, Subtitles: ${v.subtitles || 'none'}`);
        });

        let currentIndex = 0;
        let currentMedia = null;
        let started = false;
        let imageTimer = null;

        const media1 = document.getElementById('media1');
        const media2 = document.getElementById('media2');
        const img1 = document.getElementById('img1');
        const img2 = document.getElementById('img2');
        const overlay = document.getElementById('overlay');
        const titleEl = document.getElementById('title');
        const functionEl = document.getElementById('function');
        const currentEl = document.getElementById('current');
        const totalEl = document.getElementById('total');
        const startScreen = document.getElementById('startScreen');
        const statusEl = document.getElementById('status');
        const container = document.getElementById('container');
        const subtitlesEl = document.getElementById('subtitles');

        totalEl.textContent = videos.length;

        function log(msg) {
          console.log(msg);
          statusEl.textContent = msg;
        }

        function updateOverlay(video) {
          titleEl.textContent = video.title;
          functionEl.textContent = video.description || '';
          currentEl.textContent = currentIndex + 1;
        }

        // Setup subtitle display from TextTrack
        function setupSubtitleDisplay(videoElement) {
          if (!showSubtitles || !videoElement.textTracks || videoElement.textTracks.length === 0) {
            subtitlesEl.style.display = 'none';
            return;
          }

          const track = videoElement.textTracks[0];
          track.mode = 'hidden'; // hidden = loaded but not displayed natively

          track.addEventListener('cuechange', () => {
            const cues = track.activeCues;
            if (cues && cues.length > 0) {
              subtitlesEl.textContent = cues[0].text;
              subtitlesEl.style.display = 'inline-block';
            } else {
              subtitlesEl.style.display = 'none';
            }
          });

          log('Subtitle display ready');
        }

        let firstPlay = true;

        async function loadMedia(mediaElement, videoData) {
          return new Promise((resolve, reject) => {
            if (videoData.typ === 'video') {
              // Enable preload for faster startup
              mediaElement.preload = 'auto';
              mediaElement.src = videoData.url;
              // Start first video muted for autoplay, then unmute
              mediaElement.muted = firstPlay ? true : audioMuted;
              mediaElement.volume = audioVolume / 100;

              // Add subtitles if available
              if (videoData.subtitles) {
                log(`Adding subtitles: ${videoData.subtitles}`);

                // Clear existing tracks
                while (mediaElement.firstChild) {
                  mediaElement.removeChild(mediaElement.firstChild);
                }

                const track = document.createElement('track');
                track.kind = 'subtitles';
                track.label = 'Deutsch';
                track.srclang = 'de';
                track.src = videoData.subtitles;
                track.default = true;

                track.addEventListener('load', () => {
                  log('Subtitles loaded successfully');
                });

                track.addEventListener('error', (e) => {
                  log(`Subtitle error: ${e}`);
                });

                mediaElement.appendChild(track);

                // Enable text track
                setTimeout(() => {
                  if (mediaElement.textTracks[0]) {
                    mediaElement.textTracks[0].mode = 'showing';
                    log('Text track mode set to showing');
                  }
                }, 100);
              } else {
                log('No subtitles for this video');
              }

              mediaElement.load();

              // Use loadedmetadata instead of canplay for faster startup
              mediaElement.addEventListener('loadedmetadata', () => {
                log(`Video ${currentIndex + 1} metadata loaded`);
                resolve();
              }, { once: true });

              mediaElement.addEventListener('error', (e) => {
                const errorMsg = mediaElement.error ?
                  `Video error code ${mediaElement.error.code}: ${mediaElement.error.message}` :
                  'Video error (unknown)';
                log(errorMsg);
                console.error('Video element error:', mediaElement.error, 'URL:', videoData.url);
                reject(new Error(errorMsg));
              }, { once: true });
            } else {
              // Image
              mediaElement.src = videoData.url;
              mediaElement.onload = () => {
                log(`Image ${currentIndex + 1} ready`);
                resolve();
              };
              mediaElement.onerror = (e) => {
                log(`Image error`);
                reject(e);
              };
            }

            setTimeout(() => reject(new Error('Timeout')), 10000);
          });
        }

        async function playMedia(index) {
          if (index >= videos.length) {
            if (loopPlaylist) {
              index = 0; // Loop back to start
            } else {
              log('Playlist beendet - Loop deaktiviert');
              return; // Stop playback
            }
          }
          if (index < 0) {
            index = videos.length - 1;
          }

          currentIndex = index;
          const videoData = videos[index];

          log(`Loading ${videoData.typ} ${index + 1}/${videos.length}`);
          updateOverlay(videoData);

          // Determine which element to use
          let mediaEl, oldMedia;

          if (videoData.typ === 'video') {
            mediaEl = currentMedia === media1 ? media2 : media1;
            img1.style.display = 'none';
            img2.style.display = 'none';
          } else {
            mediaEl = currentMedia === img1 ? img2 : img1;
            mediaEl.style.display = 'block';
          }

          oldMedia = currentMedia;

          try {
            await loadMedia(mediaEl, videoData);

            // Fade out old media
            if (oldMedia) {
              oldMedia.classList.remove('active');
            }

            // Fade in new media
            currentMedia = mediaEl;
            currentMedia.classList.add('active');

            // Play
            if (videoData.typ === 'video') {
              // Setup subtitle display if video has subtitles
              setupSubtitleDisplay(currentMedia);

              await currentMedia.play();

              // Unmute after first video starts playing
              if (firstPlay) {
                firstPlay = false;
                setTimeout(() => {
                  currentMedia.muted = audioMuted;
                  log(`Audio enabled`);
                }, 100);
              }

              log(`Playing video ${index + 1}`);

              // Wait for video to end
              currentMedia.addEventListener('ended', () => {
                log('Video ended');
                playMedia(index + 1);
              }, { once: true });
            } else {
              log(`Showing image ${index + 1} for ${videoData.dauer}s`);

              // Wait for image duration
              clearTimeout(imageTimer);
              imageTimer = setTimeout(() => {
                playMedia(index + 1);
              }, videoData.dauer * 1000);
            }

          } catch (e) {
            log(`Error: ${e.message}`);
            // Skip to next on error
            setTimeout(() => playMedia(index + 1), 2000);
          }
        }

        function start() {
          if (started) return;
          started = true;

          log('Starting playback...');
          startScreen.classList.add('hidden');
          playMedia(0);
        }

        // Autoplay immediately for headless setup
        setTimeout(() => {
          if (!started) {
            start();
          }
        }, 100);

        // Click to start (in case autoplay is blocked)
        startScreen.addEventListener('click', start);

        // Auto-start in kiosk mode via simulated click (counts as user gesture for audio)
        setTimeout(() => {
          log('Auto-starting in kiosk mode via simulated click...');
          startScreen.click();
        }, 1000);

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
          if (!started && (e.key === ' ' || e.key === 'Enter')) {
            e.preventDefault();
            start();
          }

          // Navigation
          if (started) {
            if (e.key === 'ArrowRight') {
              if (currentMedia && currentMedia.tagName === 'VIDEO') {
                currentMedia.pause();
              }
              clearTimeout(imageTimer);
              playMedia(currentIndex + 1);
            } else if (e.key === 'ArrowLeft') {
              if (currentMedia && currentMedia.tagName === 'VIDEO') {
                currentMedia.pause();
              }
              clearTimeout(imageTimer);
              playMedia(currentIndex - 1);
            } else if (e.key === ' ') {
              e.preventDefault();
              if (currentMedia && currentMedia.tagName === 'VIDEO') {
                if (currentMedia.paused) {
                  currentMedia.play();
                } else {
                  currentMedia.pause();
                }
              }
            }
          }
        });

        log('Ready - Click to start');
      </script>
    </>
  )}
</body>
</html>
